import sys
sys.stdout.reconfigure(encoding='utf-8')
from playwright.sync_api import sync_playwright, expect
import time
import json
from datetime import datetime

results = []

def log(test, status, detail=''):
    results.append({'test': test, 'status': status, 'detail': detail, 'time': datetime.now().isoformat()})
    print(f'[{status}] {test}: {detail}')

with sync_playwright() as p:
    # Launch browser
    browser = p.chromium.launch(headless=False)
    context = browser.new_context(viewport={'width': 1920, 'height': 1080})
    page = context.new_page()
    
    # Test 1: Load page
    print('=== Starting Penetration Test - Attempt 2 ===')
    page.goto('https://sit.askmebill.com/', wait_until='networkidle')
    time.sleep(2)
    log('Page Load', 'PASS', f'Title: {page.title()}')
    page.screenshot(path='step1_loaded.png')
    
    # Test 2: Wait for and find login form
    try:
        print('Looking for login form...')
        page.wait_for_selector('input', timeout=10000)
        
        # Find all input fields
        inputs = page.locator('input').all()
        print(f'Found {len(inputs)} input fields')
        
        # Try to find username and password by placeholder or type
        username_field = None
        password_field = None
        
        for i, inp in enumerate(inputs):
            input_type = inp.get_attribute('type') or 'text'
            placeholder = inp.get_attribute('placeholder') or ''
            name = inp.get_attribute('name') or ''
            print(f'  Input {i}: type={input_type}, placeholder={placeholder}, name={name}')
            
            if input_type == 'text' or 'user' in name.lower() or 'email' in name.lower():
                username_field = inp
            elif input_type == 'password':
                password_field = inp
        
        if not username_field:
            # Try first text input
            username_field = page.locator('input[type="text"]').first
        if not password_field:
            password_field = page.locator('input[type="password"]').first
            
        if username_field and password_field:
            log('Login Form', 'FOUND', 'Username and password fields detected')
            
            # Fill username
            username_field.click()
            username_field.fill('uuio11')
            time.sleep(0.5)
            log('Username', 'FILLED', 'uuio11')
            
            # Fill password
            password_field.click()
            password_field.fill('0897421942@Earth')
            time.sleep(0.5)
            log('Password', 'FILLED', '***********')
            
            # Screenshot
            page.screenshot(path='step2_filled.png')
            
            # Find and click login button
            # Try different selectors for login button
            button_selectors = [
                'button:has-text("Login")',
                'button:has-text("Log in")',
                'button[type="submit"]',
                'input[type="submit"]',
                'button.btn-primary',
                'button:has-text("Sign in")'
            ]
            
            login_btn = None
            for selector in button_selectors:
                try:
                    btn = page.locator(selector).first
                    if btn.is_visible():
                        login_btn = btn
                        log('Login Button', 'FOUND', f'Selector: {selector}')
                        break
                except:
                    continue
            
            if login_btn:
                # Scroll to button and click
                login_btn.scroll_into_view_if_needed()
                time.sleep(0.5)
                login_btn.click()
                log('Login Button', 'CLICKED', 'Waiting for response...')
                
                # Wait for navigation or response
                time.sleep(5)
                
                # Check URL after login attempt
                current_url = page.url
                log('After Login', 'INFO', f'URL: {current_url}')
                page.screenshot(path='step3_after_login.png')
                
                # Check for error messages
                error_selectors = ['.error', '.alert-error', '.text-danger', '.text-red', '[role="alert"]']
                error_found = False
                for sel in error_selectors:
                    try:
                        error_elem = page.locator(sel).first
                        if error_elem.is_visible():
                            error_text = error_elem.inner_text()
                            log('Login Error', 'FOUND', error_text)
                            error_found = True
                            break
                    except:
                        pass
                
                if not error_found:
                    if 'login' not in current_url.lower() and 'auth' not in current_url.lower():
                        log('Login', 'SUCCESS', f'Logged in! URL: {current_url}')
                        page.screenshot(path='step4_dashboard.png')
                        
                        # Check for 2FA
                        try:
                            otp_field = page.locator('input[name="otp"], input[name="totp"], input[name="code"], input[placeholder*="code" i]').first
                            if otp_field.is_visible():
                                log('2FA', 'REQUIRED', '2FA form detected')
                                otp_field.fill('954900')
                                time.sleep(0.5)
                                
                                # Find 2FA submit
                                otp_submit = page.locator('button[type="submit"]').first
                                if otp_submit.is_visible():
                                    otp_submit.click()
                                    time.sleep(3)
                                    log('2FA', 'SUBMITTED', 'Code: 954900')
                                    page.screenshot(path='step5_after_2fa.png')
                            else:
                                log('2FA', 'NOT REQUIRED', 'No 2FA detected')
                        except:
                            log('2FA', 'NOT FOUND', 'No 2FA form')
                    else:
                        log('Login', 'PENDING', 'Still on login page - may need 2FA or credentials invalid')
            else:
                log('Login Button', 'NOT FOUND', 'Could not find login button')
        else:
            log('Login Form', 'ERROR', f'Fields not found: username={username_field}, password={password_field}')
            
    except Exception as e:
        log('Login Test', 'ERROR', str(e))
        import traceback
        traceback.print_exc()
    
    # Security headers check
    try:
        response = page.goto('https://sit.askmebill.com/')
        headers = response.headers if response else {}
        security_headers = ['strict-transport-security', 'x-frame-options', 'x-content-type-options', 'content-security-policy']
        missing = [h for h in security_headers if h not in headers]
        if missing:
            log('Security Headers', 'MISSING', f'Missing: {", ".join(missing)}')
        else:
            log('Security Headers', 'OK', 'All present')
    except Exception as e:
        log('Security Headers', 'ERROR', str(e))
    
    # Save results
    filename = f'pentest_results_v2_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
    with open(filename, 'w') as f:
        json.dump(results, f, indent=2)
    
    print(f'Results saved to: {filename}')
    browser.close()
    print('=== Test Complete ===')
    print(f'Total tests: {len(results)}')
