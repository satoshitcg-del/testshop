import sys
sys.stdout.reconfigure(encoding='utf-8')
from playwright.sync_api import sync_playwright
import time
import json
from datetime import datetime

results = []

def log(test, status, detail=''):
    results.append({'test': test, 'status': status, 'detail': detail, 'time': datetime.now().isoformat()})
    print(f'[{status}] {test}: {detail}')

with sync_playwright() as p:
    # Launch browser
    browser = p.chromium.launch(headless=False)
    context = browser.new_context(viewport={'width': 1920, 'height': 1080})
    page = context.new_page()
    
    # Test 1: Load page
    print('=== Starting Penetration Test ===')
    page.goto('https://sit.askmebill.com/')
    time.sleep(2)
    log('Page Load', 'PASS', f'Title: {page.title()}')
    
    # Test 2: Check for login form
    try:
        username_field = page.locator('input[type="text"], input[name="username"], input[name="email"]').first
        password_field = page.locator('input[type="password"]').first
        
        if username_field.is_visible() and password_field.is_visible():
            log('Login Form', 'FOUND', 'Username and password fields detected')
            
            # Test 3: Fill credentials
            username_field.fill('uuio11')
            password_field.fill('0897421942@Earth')
            log('Credentials', 'FILLED', 'Username: uuio11')
            
            # Screenshot before login
            page.screenshot(path='before_login.png')
            
            # Test 4: Submit login
            submit_btn = page.locator('button[type="submit"], input[type="submit"]').first
            if submit_btn.is_visible():
                submit_btn.click()
                log('Login Submit', 'CLICKED', 'Waiting for response...')
                
                # Wait for navigation or 2FA
                time.sleep(3)
                
                # Check current state
                current_url = page.url
                log('After Login URL', 'INFO', current_url)
                
                # Test 5: Check for 2FA
                try:
                    # Look for 2FA input
                    otp_field = page.locator('input[name="otp"], input[name="totp"], input[name="code"], input[placeholder*="code" i]').first
                    if otp_field.is_visible():
                        log('2FA Form', 'FOUND', '2FA/OTP field detected')
                        
                        # Fill 2FA
                        otp_field.fill('954900')
                        log('2FA Code', 'FILLED', '954900')
                        
                        # Submit 2FA
                        submit_btn = page.locator('button[type="submit"]').first
                        if submit_btn.is_visible():
                            submit_btn.click()
                            time.sleep(3)
                            
                            # Check if logged in
                            if 'login' not in page.url.lower() and 'auth' not in page.url.lower():
                                log('Login', 'SUCCESS', f'Logged in! URL: {page.url}')
                                page.screenshot(path='dashboard.png')
                                
                                # Test 6: Find all links
                                links = page.locator('a[href]').all()
                                link_urls = [link.get_attribute('href') for link in links[:10]]
                                log('Links Found', 'INFO', str(link_urls))
                                
                            else:
                                error_text = page.locator('.error, .alert-error, .text-red').first.inner_text() if page.locator('.error, .alert-error, .text-red').first.is_visible() else 'Unknown error'
                                log('Login', 'FAILED', f'Error: {error_text}')
                        else:
                            log('2FA Submit', 'NOT FOUND', 'Submit button not found')
                    else:
                        # No 2FA, check if logged in
                        if 'login' not in page.url.lower():
                            log('Login', 'SUCCESS', 'No 2FA required, logged in!')
                            page.screenshot(path='dashboard.png')
                        else:
                            log('Login State', 'UNKNOWN', f'URL: {current_url}')
                except Exception as e:
                    log('2FA Test', 'ERROR', str(e))
            else:
                log('Submit Button', 'NOT FOUND', 'Could not find submit button')
        else:
            log('Login Form', 'NOT FOUND', 'Login fields not visible')
    except Exception as e:
        log('Login Test', 'ERROR', str(e))
    
    # Test 7: Security headers check
    try:
        response = page.goto('https://sit.askmebill.com/')
        headers = response.headers
        security_headers = ['strict-transport-security', 'x-frame-options', 'x-content-type-options', 'content-security-policy']
        missing = [h for h in security_headers if h not in headers]
        if missing:
            log('Security Headers', 'MISSING', f'Missing: {", ".join(missing)}')
        else:
            log('Security Headers', 'OK', 'All present')
    except:
        pass
    
    # Save results
    filename = f'pentest_results_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json'
    with open(filename, 'w') as f:
        json.dump(results, f, indent=2)
    
    print(f'Results saved to: {filename}')
    browser.close()
    print('=== Test Complete ===')
    print(f'Total tests: {len(results)}')
