# API Security Testing Script (PowerShell)
# Usage: .\api-test.ps1 https://api.target.com [auth_token]

param(
    [Parameter(Mandatory=$true)]
    [string]$ApiUrl,
    
    [Parameter(Mandatory=$false)]
    [string]$Token = ""
)

Write-Host "=== API Security Testing for $ApiUrl ===" -ForegroundColor Green
Write-Host "Started: $(Get-Date)"
Write-Host ""

# Headers
$Headers = @{}
if ($Token) {
    $Headers['Authorization'] = "Bearer $Token"
}

# Test 1: Authentication Bypass
Write-Host "[*] Test 1: Authentication Bypass" -ForegroundColor Yellow
try {
    $Response = Invoke-WebRequest -Uri "$ApiUrl/users" -Method Get -TimeoutSec 10
    Write-Host "  Response without auth: $($Response.StatusCode)" -ForegroundColor Red
    Write-Host "  ⚠️  Possible authentication bypass!" -ForegroundColor Red
} catch {
    $StatusCode = $_.Exception.Response.StatusCode.value__
    Write-Host "  Response without auth: $StatusCode" -ForegroundColor Green
}

# Test 2: HTTP Methods
Write-Host ""
Write-Host "[*] Test 2: HTTP Methods" -ForegroundColor Yellow
$Methods = @('GET', 'POST', 'PUT', 'DELETE', 'PATCH')
foreach ($Method in $Methods) {
    try {
        $Response = Invoke-WebRequest -Uri "$ApiUrl/test" -Method $Method -TimeoutSec 5
        Write-Host "  $Method /test: $($Response.StatusCode)" -ForegroundColor $(if ($Method -eq 'DELETE' -or $Method -eq 'PUT') { 'Red' } else { 'Green' })
    } catch {
        $StatusCode = $_.Exception.Response.StatusCode.value__
        Write-Host "  $Method /test: $StatusCode" -ForegroundColor Gray
    }
}

# Test 3: Security Headers
Write-Host ""
Write-Host "[*] Test 3: Security Headers" -ForegroundColor Yellow
try {
    $Response = Invoke-WebRequest -Uri $ApiUrl -Method Head -TimeoutSec 10
    $SecurityHeaders = @('X-Content-Type-Options', 'X-Frame-Options', 'Content-Security-Policy', 
                         'Strict-Transport-Security', 'X-XSS-Protection')
    $FoundHeaders = @()
    foreach ($Header in $SecurityHeaders) {
        if ($Response.Headers[$Header]) {
            $FoundHeaders += "✅ $Header"
        } else {
            $FoundHeaders += "❌ $Header (Missing)"
        }
    }
    $FoundHeaders | ForEach-Object { Write-Host "  $_" }
} catch {
    Write-Host "  Could not retrieve headers" -ForegroundColor Red
}

# Test 4: SQL Injection Test
Write-Host ""
Write-Host "[*] Test 4: SQL Injection Test" -ForegroundColor Yellow
$Payloads = @(
    "1'",
    "1' OR '1'='1",
    "1' AND 1=1--",
    "1' AND 1=2--"
)
foreach ($Payload in $Payloads) {
    $EncodedPayload = [System.Web.HttpUtility]::UrlEncode($Payload)
    try {
        $Response = Invoke-WebRequest -Uri "$ApiUrl/users?id=$EncodedPayload" -TimeoutSec 10
        if ($Response.Content -match "error|exception|sql|syntax") {
            Write-Host "  Payload '$Payload' may have triggered SQL error!" -ForegroundColor Red
        }
    } catch {
        $StatusCode = $_.Exception.Response.StatusCode.value__
        if ($StatusCode -eq 500) {
            Write-Host "  Payload '$Payload' caused 500 error - possible SQLi!" -ForegroundColor Red
        }
    }
}

# Test 5: IDOR Test (if authenticated)
if ($Token) {
    Write-Host ""
    Write-Host "[*] Test 5: IDOR (Insecure Direct Object Reference)" -ForegroundColor Yellow
    $TestIds = @(1, 2, 3, 9999)
    foreach ($Id in $TestIds) {
        try {
            $Response = Invoke-WebRequest -Uri "$ApiUrl/users/$Id" -Headers $Headers -TimeoutSec 10
            if ($Response.StatusCode -eq 200) {
                Write-Host "  Resource $Id: Accessible (200)" -ForegroundColor $(if ($Id -ne 1) { 'Red' } else { 'Green' })
                if ($Id -ne 1) {
                    Write-Host "    ⚠️  Possible IDOR vulnerability!" -ForegroundColor Red
                }
            }
        } catch {
            $StatusCode = $_.Exception.Response.StatusCode.value__
            Write-Host "  Resource $Id: $StatusCode" -ForegroundColor Gray
        }
    }
}

# Test 6: Mass Assignment
Write-Host ""
Write-Host "[*] Test 6: Mass Assignment" -ForegroundColor Yellow
$TestBodies = @(
    '{"username":"test","password":"test","admin":true}',
    '{"username":"test","password":"test","role":"admin"}',
    '{"username":"test","password":"test","isAdmin":true}'
)
foreach ($Body in $TestBodies) {
    try {
        $Response = Invoke-WebRequest -Uri "$ApiUrl/register" -Method Post `
            -ContentType "application/json" -Body $Body -TimeoutSec 10
        Write-Host "  Mass assignment test: $($Response.StatusCode)" -ForegroundColor $(if ($Response.StatusCode -eq 201 -or $Response.StatusCode -eq 200) { 'Red' } else { 'Green' })
    } catch {
        $StatusCode = $_.Exception.Response.StatusCode.value__
        Write-Host "  Mass assignment test: $StatusCode" -ForegroundColor Gray
    }
}

# Test 7: Rate Limiting
Write-Host ""
Write-Host "[*] Test 7: Rate Limiting (10 rapid requests)" -ForegroundColor Yellow
$RateLimitResults = @()
1..10 | ForEach-Object {
    try {
        $Response = Invoke-WebRequest -Uri "$ApiUrl/users" -TimeoutSec 5
        $RateLimitResults += $Response.StatusCode
    } catch {
        $StatusCode = $_.Exception.Response.StatusCode.value__
        $RateLimitResults += $StatusCode
    }
}
$RateLimit429Count = ($RateLimitResults | Where-Object { $_ -eq 429 }).Count
if ($RateLimit429Count -gt 0) {
    Write-Host "  ✅ Rate limiting detected ($RateLimit429Count requests blocked)" -ForegroundColor Green
} else {
    Write-Host "  ❌ No rate limiting detected" -ForegroundColor Red
}

Write-Host ""
Write-Host "=== API Testing Complete ===" -ForegroundColor Green
Write-Host "Finished: $(Get-Date)"
