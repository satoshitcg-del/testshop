#!/bin/bash
# API Security Testing Script
# Usage: ./api-test.sh https://api.target.com

API_URL=$1
TOKEN=${2:-""}  # Optional auth token

if [ -z "$API_URL" ]; then
    echo "Usage: $0 <api_url> [auth_token]"
    echo "Example: $0 https://api.target.com/v1"
    exit 1
fi

echo "=== API Security Testing for $API_URL ==="
echo "Started: $(date)"
echo ""

# Headers
AUTH_HEADER=""
if [ -n "$TOKEN" ]; then
    AUTH_HEADER="-H \"Authorization: Bearer $TOKEN\""
fi

# Test 1: Check for authentication bypass
echo "[*] Test 1: Authentication Bypass"
echo "Testing endpoints without authentication..."
curl -s -o /dev/null -w "%{http_code}" $API_URL/users
echo ""

# Test 2: HTTP Methods
echo ""
echo "[*] Test 2: HTTP Methods"
for method in GET POST PUT DELETE PATCH; do
    echo -n "Testing $method /test: "
    curl -s -o /dev/null -w "%{http_code}" -X $method $API_URL/test 2>/dev/null
    echo ""
done

# Test 3: Security Headers
echo ""
echo "[*] Test 3: Security Headers"
curl -s -I $API_URL | grep -i "x-content\|x-frame\|content-security\|strict-transport\|x-xss" 2>/dev/null || echo "No security headers found"

# Test 4: SQL Injection Test
echo ""
echo "[*] Test 4: SQL Injection"
echo "Testing parameter: id"
curl -s "$API_URL/users?id=1'" 2>/dev/null | head -5
curl -s "$API_URL/users?id=1' OR '1'='1" 2>/dev/null | head -5

# Test 5: IDOR Test (if authenticated)
if [ -n "$TOKEN" ]; then
    echo ""
    echo "[*] Test 5: IDOR (Insecure Direct Object Reference)"
    echo "Testing different resource IDs..."
    for id in 1 2 3 9999; do
        echo -n "Resource $id: "
        curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" "$API_URL/users/$id" 2>/dev/null
        echo ""
    done
fi

# Test 6: Rate Limiting
echo ""
echo "[*] Test 6: Rate Limiting"
echo "Sending 10 requests rapidly..."
for i in {1..10}; do
    curl -s -o /dev/null -w "%{http_code}\n" $API_URL/users 2>/dev/null &
done
wait
echo "Check for 429 (Too Many Requests)"

# Test 7: Mass Assignment
echo ""
echo "[*] Test 7: Mass Assignment"
echo "Testing for additional parameter acceptance..."
curl -s -X POST $API_URL/register \
    -H "Content-Type: application/json" \
    -d '{"username":"test","password":"test","admin":true}' 2>/dev/null | head -5

echo ""
echo "=== API Testing Complete ==="
echo "Finished: $(date)"
