#!/bin/bash
# Pentest Testing Script for Askmebill SIT
# Target: https://sit.askmebill.com/
# Usage: bash askmebill-pentest.sh

echo "========================================="
echo "  Askmebill SIT - Penetration Test"
echo "  Target: https://sit.askmebill.com/"
echo "  Date: $(date)"
echo "========================================="
echo ""

TARGET="https://sit.askmebill.com"
OUTPUT_DIR="pentest-results-askmebill-$(date +%Y%m%d)"
mkdir -p "$OUTPUT_DIR"

echo "[*] Creating output directory: $OUTPUT_DIR"
echo ""

# 1. Reconnaissance
echo "[1/6] Reconnaissance"
echo "--------------------"

echo "[*] Checking basic connectivity..."
curl -s -I "$TARGET" -o "$OUTPUT_DIR/headers.txt" -w "HTTP Status: %{http_code}\nContent-Type: %{content_type}\n"

echo "[*] Getting server headers..."
cat "$OUTPUT_DIR/headers.txt" | grep -i "server\|x-powered-by\|via" || echo "No server info disclosed"

echo "[*] Checking security headers..."
echo "Security Headers Check:"
curl -s -I "$TARGET" | grep -i "strict-transport\|x-frame\|x-content\|content-security\|x-xss" || echo "⚠️  Missing security headers"

echo ""

# 2. SSL/TLS Analysis
echo "[2/6] SSL/TLS Analysis"
echo "----------------------"

echo "[*] Checking SSL certificate..."
echo | openssl s_client -connect sit.askmebill.com:443 -servername sit.askmebill.com 2>/dev/null | openssl x509 -noout -dates -subject -issuer > "$OUTPUT_DIR/ssl-info.txt" || echo "⚠️  Could not retrieve SSL info"

echo "[*] Testing SSL protocols (requires testssl if available)..."
if command -v testssl &> /dev/null; then
    testssl --fast "$TARGET" > "$OUTPUT_DIR/testssl-results.txt" 2>&1 &
    echo "✓ testssl running in background"
else
    echo "ℹ️  testssl not installed (optional)"
fi

echo ""

# 3. DNS Enumeration
echo "[3/6] DNS Enumeration"
echo "---------------------"

echo "[*] DNS records..."
dig +short sit.askmebill.com > "$OUTPUT_DIR/dns-a.txt"
cat "$OUTPUT_DIR/dns-a.txt"

echo "[*] MX records..."
dig +short MX askmebill.com 2>/dev/null > "$OUTPUT_DIR/dns-mx.txt" || echo "No MX records"

echo "[*] TXT/SPF records..."
dig +short TXT askmebill.com 2>/dev/null > "$OUTPUT_DIR/dns-txt.txt" || echo "No TXT records"

echo ""

# 4. Common Endpoint Discovery
echo "[4/6] Common Endpoint Discovery"
echo "--------------------------------"

ENDPOINTS=(
    "/robots.txt"
    "/sitemap.xml"
    "/.well-known/security.txt"
    "/admin"
    "/login"
    "/api"
    "/swagger"
    "/api/docs"
)

echo "[*] Testing common endpoints..."
for endpoint in "${ENDPOINTS[@]}"; do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$TARGET$endpoint")
    if [ "$STATUS" != "404" ]; then
        echo "  Found: $endpoint (HTTP $STATUS)"
        echo "$endpoint - HTTP $STATUS" >> "$OUTPUT_DIR/discovered-endpoints.txt"
    fi
done

if [ ! -f "$OUTPUT_DIR/discovered-endpoints.txt" ]; then
    echo "  No common endpoints found (may require authentication)"
fi

echo ""

# 5. Technology Detection
echo "[5/6] Technology Detection"
echo "---------------------------"

echo "[*] Analyzing response headers..."
curl -s -I "$TARGET" > "$OUTPUT_DIR/full-headers.txt"

echo "[*] Looking for framework indicators..."
curl -s "$TARGET" | grep -i "csrf-token\|__RequestVerificationToken\|wp-content\|drupal\|jquery\|react\|vue\|angular" > "$OUTPUT_DIR/tech-indicators.txt" || echo "No obvious framework indicators"

echo ""

# 6. Security Test Checklist
echo "[6/6] Manual Testing Checklist"
echo "-------------------------------"
echo ""
echo "⚠️  MANUAL TESTING REQUIRED ⚠️"
echo ""
cat << 'EOF' > "$OUTPUT_DIR/manual-testing-checklist.md"
# Manual Testing Checklist - Askmebill SIT

## Authentication Testing
- [ ] Test login with provided credentials
- [ ] Test 2FA flow
- [ ] Test password reset functionality
- [ ] Test account lockout policy
- [ ] Test brute force protection
- [ ] Test session timeout
- [ ] Test concurrent sessions
- [ ] Test logout functionality

## Input Validation
- [ ] SQL Injection on login form
- [ ] SQL Injection on search
- [ ] XSS in all input fields
- [ ] CSRF token validation
- [ ] File upload restrictions (if applicable)

## Session Management
- [ ] Session ID randomness
- [ ] Session fixation
- [ ] Cookie security flags (HttpOnly, Secure, SameSite)

## Access Control
- [ ] IDOR testing
- [ ] Horizontal privilege escalation
- [ ] Vertical privilege escalation
- [ ] Forceful browsing

## Business Logic
- [ ] Billing amount manipulation
- [ ] Payment flow bypass
- [ ] Rate limiting
- [ ] Workflow bypass

## API Testing
- [ ] API authentication
- [ ] API rate limiting
- [ ] API input validation
- [ ] API versioning

## Test Credentials
- URL: https://sit.askmebill.com/
- Username: uuio11
- Password: [REDACTED - See secure storage]
- 2FA: 954900
EOF

echo "✓ Checklist created: $OUTPUT_DIR/manual-testing-checklist.md"
echo ""

# Summary
echo "========================================="
echo "  Testing Summary"
echo "========================================="
echo "Output Directory: $OUTPUT_DIR"
echo ""
echo "Files Generated:"
ls -la "$OUTPUT_DIR/"
echo ""
echo "Next Steps:"
echo "1. Review results in $OUTPUT_DIR/"
echo "2. Complete manual testing checklist"
echo "3. Use Browser with Burp Suite for authenticated testing"
echo "4. Update this report with findings"
echo ""
echo "========================================="
